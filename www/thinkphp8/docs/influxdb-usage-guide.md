# InfluxDB 使用指南

## 什么是InfluxDB

InfluxDB是一个开源的时序数据库（Time Series Database，TSDB），专为高写入、低更新频率的时间序列数据设计。它具有高性能的数据压缩和查询能力，特别适合存储监控指标、传感器数据、事件和日志等时间序列数据。

## 何时使用InfluxDB

### 适合使用InfluxDB的场景

以下场景特别适合使用InfluxDB存储数据：

1. **时间序列数据**：数据点必须包含时间戳，且按时间顺序组织
2. **高写入频率**：需要处理大量的写入操作（每秒数千到数百万个数据点）
3. **低更新频率**：数据一旦写入很少或从不更新（追加模式）
4. **时间范围查询**：查询通常基于时间范围（如「过去24小时的CPU使用率」）
5. **聚合分析**：需要对时间序列数据进行聚合计算（如平均值、最大值、最小值等）

### 不适合使用InfluxDB的场景

以下场景不适合使用InfluxDB：

1. **关系型数据**：需要复杂的多表关联查询
2. **高频率更新**：数据需要频繁更新
3. **事务支持**：需要ACID事务保证
4. **非时间序列数据**：数据不包含时间维度或不按时间组织

## 数据类型筛选指南

### 适合存储在InfluxDB的数据类型

1. **系统和应用监控指标**
   - CPU、内存、磁盘使用率
   - 网络流量统计
   - 应用响应时间
   - 错误率和请求率

2. **队列监控指标**
   - 队列长度
   - 处理时间
   - 成功率和错误率
   - 吞吐量

3. **结构化日志**
   - 应用程序日志（带时间戳）
   - 系统事件日志
   - 安全审计日志

4. **传感器和设备数据**
   - IoT设备遥测数据
   - 环境传感器数据（温度、湿度等）
   - 设备状态监控

5. **事件数据**
   - 用户行为事件（点击、浏览等）
   - 系统事件（启动、关闭等）
   - 业务事件（但不包含完整的业务交易数据）

### 停车场系统中适合存储在InfluxDB的数据

1. **闸机事件数据**
   - 车辆进出场事件
   - 闸机开关状态变化
   - 车牌识别事件

2. **车位占用统计**
   - 实时车位占用率
   - 分区域占用情况
   - 历史占用趋势

3. **系统性能监控**
   - API响应时间
   - 系统资源使用情况
   - 队列处理性能

4. **高峰时段分析**
   - 进出场高峰时段识别
   - 停车时长分布
   - 周期性模式分析

### 不适合存储在InfluxDB的数据

1. **用户账户信息**
   - 用户个人资料
   - 认证和授权信息
   - 账户余额

2. **业务交易数据**
   - 完整的支付交易记录
   - 订单信息
   - 发票和收据

3. **车辆和车主信息**
   - 车辆基本信息
   - 车主联系方式
   - 月租车合同信息

4. **配置和参数设置**
   - 系统配置
   - 收费规则
   - 权限设置

## 实现指南

### 数据存储决策流程

在决定是否将数据存储到InfluxDB时，请遵循以下流程：

1. **检查数据特性**
   - 数据是否包含时间戳？
   - 数据是否主要用于追加而非更新？
   - 查询是否主要基于时间范围？

2. **检查数据类型**
   - 数据是否属于监控指标、事件、日志或传感器数据？
   - 数据是否需要关系型查询？
   - 数据是否需要事务支持？

3. **检查使用场景**
   - 数据是否用于趋势分析和可视化？
   - 数据是否需要高频写入？
   - 数据是否需要长期存储和自动清理策略？

### 使用配置文件筛选

系统已提供`config/influxdb.php`配置文件，其中定义了详细的数据筛选条件。在代码中，可以使用`InfluxDBService`服务类来判断特定数据是否应该存储到InfluxDB：

```php
// 获取InfluxDB服务实例
$influxService = app('\app\service\InfluxDBService');

// 判断特定数据类型和使用场景是否应该存储到InfluxDB
$shouldStore = $influxService->shouldStoreInInfluxDB(
    'metrics',              // 数据类型
    'queue_monitoring',     // 使用场景
    'processing_time'       // 指标名称
);

// 如果应该存储到InfluxDB，则写入数据
if ($shouldStore) {
    $influxService->writeQueueMetrics('default', [
        'waiting' => 10,
        'processing' => 5,
        'failed' => 2,
        'success' => 100
    ]);
}
```

## 最佳实践

1. **合理设置保留策略**
   - 根据数据重要性和使用频率设置不同的保留期限
   - 高精度数据可以设置较短的保留期限，聚合后的数据可以保留更长时间

2. **使用标签进行高效查询**
   - 将常用的查询条件设置为标签（tags）而非字段（fields）
   - 标签会被索引，可以显著提高查询性能

3. **批量写入数据**
   - 使用批量写入API减少网络开销
   - 合理设置批量大小和刷新间隔

4. **合理设计数据模型**
   - 使用有意义的measurement名称
   - 保持tag和field的一致性
   - 避免过多的cardinality（唯一标签组合数量）

5. **监控InfluxDB性能**
   - 关注写入和查询性能
   - 监控磁盘使用情况
   - 定期优化和压缩数据

## 结论

InfluxDB是处理时间序列数据的强大工具，但并不适合所有类型的数据。通过遵循本指南中的筛选条件和最佳实践，可以充分利用InfluxDB的优势，同时避免不适合的使用场景带来的问题。

在停车场系统中，将监控指标、事件数据和统计分析数据存储在InfluxDB中，而将用户信息、交易数据和业务配置存储在关系型数据库中，可以实现最佳的系统性能和数据管理效率。

- 在路由配置文件`route/app.php` 中添加了一组停车场监控指标管理的路由，包括：

- 记录车位占用率数据的接口`/parking/metrics/occupancy`
- 记录设备状态数据的接口`/parking/metrics/device-status`
- 记录车牌识别性能数据的接口`/parking/metrics/plate-recognition`
- 记录闸机操作日志的接口`/parking/metrics/gate-operation`
- 记录高峰期分析数据的接口`/parking/metrics/peak-hours`
- 生成停车时长统计数据的接口`/parking/metrics/duration-stats`
- 分析高峰期数据的接口`/parking/metrics/peak-analysis`
- 获取车位占用率历史数据的接口`/parking/metrics/occupancy-history`
- 获取设备状态历史数据的接口`/parking/metrics/device-history`
- 在`ParkingMetricsController` 控制器中实现了`getDeviceStatusHistory` 方法，用于获取设备状态的历史数据。该方法接收设备ID、开始时间和结束时间参数，调用`InfluxDBService` 的`getDeviceStatusHistory` 方法查询数据，并将结果格式化后返回。